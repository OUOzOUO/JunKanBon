<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç·šä¸ŠçŒœæ‹³å¤§æˆ° - ç©©å®šç‰ˆ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
</head>
<body class="bg-slate-100 flex flex-col items-center justify-center min-h-screen p-4 font-sans">

    <div id="setup-screen" class="bg-white p-8 rounded-xl shadow-lg w-full max-w-sm text-center">
        <h1 class="text-2xl font-bold mb-6 text-indigo-600">âœŒï¸ ç·šä¸ŠçŒœæ‹³å¤§æˆ°</h1>
        <button onclick="createNewRoom()" class="w-full bg-indigo-500 text-white py-3 rounded-lg mb-4 hover:bg-indigo-600 transition font-bold">å»ºç«‹æ–°æˆ¿é–“</button>
        <div class="flex gap-2">
            <input id="room-input" type="text" placeholder="è¼¸å…¥4ä½æˆ¿è™Ÿ" class="flex-1 border p-3 rounded-lg text-center focus:ring-2 focus:ring-indigo-500 outline-none">
            <button onclick="joinRoom()" class="bg-emerald-500 text-white px-4 py-3 rounded-lg hover:bg-emerald-600 font-bold">åŠ å…¥</button>
        </div>
        <p class="mt-4 text-xs text-gray-400">è«‹å…¶ä¸­ä¸€äººå»ºç«‹æˆ¿é–“ï¼Œå¦ä¸€äººè¼¸å…¥æˆ¿è™ŸåŠ å…¥</p>
    </div>

    <div id="game-screen" class="hidden bg-white p-8 rounded-xl shadow-lg w-full max-w-sm text-center">
        <h2 id="display-room-id" class="text-sm text-gray-400 mb-2 font-mono">æˆ¿é–“è™Ÿï¼š----</h2>
        <div id="status-msg" class="text-lg font-semibold mb-6 text-gray-700 h-8">ç­‰å¾…å°æ‰‹åŠ å…¥...</div>
        
        <div id="controls" class="grid grid-cols-3 gap-4 mb-8">
            <button onclick="play('çŸ³é ­')" class="text-4xl p-4 bg-gray-50 rounded-xl hover:bg-indigo-100 border-2 border-transparent transition active:scale-95">âœŠ</button>
            <button onclick="play('å‰ªåˆ€')" class="text-4xl p-4 bg-gray-50 rounded-xl hover:bg-indigo-100 border-2 border-transparent transition active:scale-95">âœŒï¸</button>
            <button onclick="play('å¸ƒ')" class="text-4xl p-4 bg-gray-50 rounded-xl hover:bg-indigo-100 border-2 border-transparent transition active:scale-95">ğŸ–ï¸</button>
        </div>

        <div id="result-area" class="hidden border-t pt-6 animate-bounce-short">
            <div class="flex justify-around mb-4">
                <div class="text-center">
                    <p class="text-xs text-gray-500 mb-1">ä½ å‡ºäº†</p>
                    <p id="my-move" class="text-4xl">?</p>
                </div>
                <div class="text-center">
                    <p class="text-xs text-gray-500 mb-1">å°æ–¹å‡º</p>
                    <p id="opp-move" class="text-4xl">?</p>
                </div>
            </div>
            <div id="final-result" class="text-3xl font-black text-red-500 italic mb-4"></div>
            <button onclick="location.reload()" class="w-full bg-gray-200 text-gray-700 py-2 rounded-lg text-sm hover:bg-gray-300 transition">å›é¦–é  / å†ç©ä¸€æ¬¡</button>
        </div>
    </div>

    <script>
        // --- Firebase è¨­å®š (å·²å¡«å…¥ä½ çš„è³‡æ–™) ---
        const firebaseConfig = {
            apiKey: "AIzaSyCkqnrJZWo66jXTUmLzs4iA-9HHhAJQ06A",
            authDomain: "junkanbon.firebaseapp.com",
            projectId: "junkanbon",
            storageBucket: "junkanbon.firebasestorage.app",
            messagingSenderId: "548450406216",
            appId: "1:548450406216:web:d5ce6a06f141b011a7ed7d",
            measurementId: "G-G324W6H3BV",
            databaseURL: "https://junkanbon-default-rtdb.firebaseio.com" 
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        let currentRoom = null;
        let myRole = null; 

        // 1. å»ºç«‹æˆ¿é–“
        function createNewRoom() {
            const rid = Math.floor(1000 + Math.random() * 9000);
            myRole = 'player1';
            db.ref('rooms/' + rid).set({
                player1: { choice: "", status: "waiting" },
                player2: { choice: "", status: "waiting" },
                createdAt: Date.now()
            }).then(() => {
                enterRoom(rid);
            }).catch(err => alert("å»ºç«‹å¤±æ•—ï¼š" + err));
        }

        // 2. åŠ å…¥æˆ¿é–“ (å«è‡ªå‹•åˆ†é…èº«åˆ†é‚è¼¯)
        function joinRoom() {
            const rid = document.getElementById('room-input').value;
            if(!rid) return alert("è«‹è¼¸å…¥æˆ¿è™Ÿ");

            db.ref('rooms/' + rid).once('value', (snapshot) => {
                if (snapshot.exists()) {
                    const data = snapshot.val();
                    
                    // è‡ªå‹•åˆ¤æ–·èº«åˆ†ï¼šè‹¥ P1 é‚„æ²’æº–å‚™å¥½æˆ–è³‡æ–™ç‚ºç©ºï¼Œå‰‡è£œä½ P1ï¼Œå¦å‰‡ç•¶ P2
                    if (!data.player1 || data.player1.status === 'waiting') {
                        myRole = 'player1';
                    } else {
                        myRole = 'player2';
                    }
                    
                    enterRoom(rid);
                } else {
                    alert("âŒ æ‰¾ä¸åˆ°æˆ¿é–“ " + rid + "ï¼Œè«‹ç¢ºèªæˆ¿è™Ÿæˆ–é‡æ–°å»ºç«‹ã€‚");
                }
            });
        }

        // 3. é€²å…¥æˆ¿é–“ç•«é¢
        function enterRoom(rid) {
            currentRoom = rid;
            document.getElementById('setup-screen').classList.add('hidden');
            document.getElementById('game-screen').classList.remove('hidden');
            document.getElementById('display-room-id').innerText = "æˆ¿é–“è™Ÿï¼š" + rid;
            listenRoom(rid);
        }

        // 4. ç›£è½æˆ¿é–“å‹•æ…‹
        function listenRoom(rid) {
            db.ref('rooms/' + rid).on('value', (snapshot) => {
                const data = snapshot.val();
                if(!data) return;

                const me = data[myRole];
                const oppRole = (myRole === 'player1') ? 'player2' : 'player1';
                const opp = data[oppRole];

                // æ›´æ–°æç¤ºæ–‡å­—
                if (opp.status === 'ready' && me.status !== 'ready') {
                    document.getElementById('status-msg').innerText = "å°æ‰‹å·²å‡ºæ‹³ï¼å¿«é¸ä¸€å€‹ï¼";
                } else if (me.status === 'ready' && opp.status !== 'ready') {
                    document.getElementById('status-msg').innerText = "å·²å‡ºæ‹³ï¼Œç­‰å¾…å°æ‰‹ä¸­...";
                } else if (me.status === 'ready' && opp.status === 'ready') {
                    document.getElementById('status-msg').innerText = "é›™æ–¹çš†å·²å‡ºæ‹³ï¼";
                    showResult(me.choice, opp.choice);
                } else {
                    document.getElementById('status-msg').innerText = "ç­‰å¾…å°æ‰‹åŠ å…¥æˆ–å‡ºæ‹³...";
                }
            });
        }

        // 5. é»æ“Šå‡ºæ‹³
        function play(move) {
            if (!currentRoom || !myRole) return;
            
            db.ref(`rooms/${currentRoom}/${myRole}`).update({
                choice: move,
                status: 'ready'
            });
            
            // å‡ºæ‹³å¾Œç¦ç”¨æŒ‰éˆ•
            document.getElementById('controls').classList.add('pointer-events-none', 'opacity-50');
        }

        // 6. é¡¯ç¤ºçµæœ
        function showResult(myMove, oppMove) {
            const resultArea = document.getElementById('result-area');
            resultArea.classList.remove('hidden');
            
            document.getElementById('my-move').innerText = moveEmoji(myMove);
            document.getElementById('opp-move').innerText = moveEmoji(oppMove);
            
            const resultText = judge(myMove, oppMove);
            document.getElementById('final-result').innerText = resultText;
            
            // æ ¹æ“šå‹è² è®Šæ›é¡è‰²
            const resEl = document.getElementById('final-result');
            if(resultText.includes("è´")) resEl.className = "text-3xl font-black text-orange-500 italic mb-4";
            else if(resultText.includes("è¼¸")) resEl.className = "text-3xl font-black text-slate-500 italic mb-4";
            else resEl.className = "text-3xl font-black text-blue-500 italic mb-4";
        }

        function moveEmoji(m) {
            return m === 'çŸ³é ­' ? 'âœŠ' : (m === 'å‰ªåˆ€' ? 'âœŒï¸' : 'ğŸ–ï¸');
        }

        function judge(me, opp) {
            if(me === opp) return "å¹³æ‰‹ï¼ğŸ¤";
            if((me === 'çŸ³é ­' && opp === 'å‰ªåˆ€') || (me === 'å‰ªåˆ€' && opp === 'å¸ƒ') || (me === 'å¸ƒ' && opp === 'çŸ³é ­')) return "ä½ è´äº†ï¼ğŸ”¥";
            return "ä½ è¼¸äº†...ğŸ’€";
        }
    </script>

    <style>
        @keyframes bounce-short {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }
        .animate-bounce-short {
            animation: bounce-short 0.5s ease-in-out 1;
        }
    </style>
</body>
</html>
